// E2E tests for tuple-returning functions
// BUG FIXED: "let t = (tuple) in t" pattern now works correctly
// Root cause: ANF optimization (beta reduction) was missing in compileWithStdlib path

// =====================================================
// FIXED: "let t = (a, b) in t" pattern now works
// =====================================================

def test(a: Int64) : (Int64, Int64) = let t = (a, a * 2) in t
let r = test(5) in r.0 = stdout="5\n"

def makeNext(t: (Int64, Int64)) : (Int64, Int64) = let next = (t.0+1, t.1+2) in next
let r2 = makeNext((0, 0)) in r2.0 = stdout="1\n"

// =====================================================
// Direct tuple return without let binding
// =====================================================
def addToTupleDirect(t: (Int64, Int64)) : (Int64, Int64) = (t.0 + 1, t.1 + 2)

let r3 = addToTupleDirect((5, 10)) in r3.0 + r3.1 = stdout="18\n"

let r4 = addToTupleDirect((0, 0)) in r4.0 = stdout="1\n"

let r5 = addToTupleDirect((0, 0)) in r5.1 = stdout="2\n"

// =====================================================
// Accessing tuple elements inside the function
// =====================================================
def getFirst(a: Int64) : Int64 = let t = (a, a * 2) in t.0
getFirst(5) = stdout="5\n"

def getSecond(a: Int64) : Int64 = let t = (a, a * 2) in t.1
getSecond(5) = stdout="10\n"
