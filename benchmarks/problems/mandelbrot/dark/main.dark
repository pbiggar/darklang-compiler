// Mandelbrot Benchmark
// Generates a Mandelbrot set and counts points in the set
// From: Computer Language Benchmarks Game
//
// This benchmark tests:
// - Floating point arithmetic
// - Nested loops
// - Complex number simulation
// - Iteration limits
//
// Expected output for 10x10 with maxIter=10 is 50.

// Check if point (cr, ci) is in the Mandelbrot set
// Returns 1 if point escapes within maxIter iterations, 0 otherwise
def iterate(cr: Float, ci: Float, zr: Float, zi: Float, iter: Int64, maxIter: Int64) : Int64 =
    if iter >= maxIter then
        0  // Point is in the set
    else
        let zr2 = zr * zr in
        let zi2 = zi * zi in
        if zr2 + zi2 > 4.0 then
            1  // Point escaped
        else
            // z = z^2 + c
            let newZr = zr2 - zi2 + cr in
            let newZi = 2.0 * zr * zi + ci in
            iterate(cr, ci, newZr, newZi, iter + 1, maxIter)

// Count escaped points in a row from x=startX to x=endX-1
def countRow(y: Int64, startX: Int64, endX: Int64, size: Int64, maxIter: Int64, count: Int64) : Int64 =
    if startX >= endX then
        count
    else
        let sizeF = Stdlib.Int64.toFloat(size) in
        let xf = Stdlib.Int64.toFloat(startX) in
        let yf = Stdlib.Int64.toFloat(y) in
        let cr = 2.0 * xf / sizeF - 1.5 in
        let ci = 2.0 * yf / sizeF - 1.0 in
        let escaped = iterate(cr, ci, 0.0, 0.0, 0, maxIter) in
        countRow(y, startX + 1, endX, size, maxIter, count + escaped)

// Count escaped points in all rows from y=startY to y=endY-1
def countAll(startY: Int64, endY: Int64, size: Int64, maxIter: Int64, count: Int64) : Int64 =
    if startY >= endY then
        count
    else
        let rowCount = countRow(startY, 0, size, size, maxIter, 0) in
        countAll(startY + 1, endY, size, maxIter, count + rowCount)

// Full benchmark: size=200, maxIter=50
countAll(0, 200, 200, 50, 0)
